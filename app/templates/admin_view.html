{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4 text-light">
        <h2> Admin Dashboard</h2>
        <div>
            <a href="{{ url_for('home') }}" class="btn btn-outline-light me-2">‚Üê Home</a>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">Logout</a>
        </div>
    </div>

    <!-- Dataset Statistics -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h5 class="mb-0 text-light"> Dataset Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-2">
                            <div class="fw-bold text-uppercase text-secondary small mb-1">
                                Total Ratings
                            </div>
                            <h3 class="text-primary mb-0">
                                {{ '{:,}'.format(stats.total_ratings) }}
                            </h3>
                            <small class="text-muted">
                                T·ªïng s·ªë ƒë√°nh gi√° trong h·ªá th·ªëng
                            </small>
                        </div>
                        <div class="col-md-2">
                            <div class="fw-bold text-uppercase text-secondary small mb-1">
                                Total Movies
                            </div>
                            <h3 class="text-success mb-0">
                                {{ '{:,}'.format(stats.total_movies) }}
                            </h3>
                            <small class="text-muted">
                                S·ªë l∆∞·ª£ng phim kh√°c nhau
                            </small>
                        </div>
                        <div class="col-md-2">
                            <div class="fw-bold text-uppercase text-secondary small mb-1">
                                Total Users
                            </div>
                            <h3 class="text-warning mb-0">
                                {{ '{:,}'.format(stats.total_users) }}
                            </h3>
                            <small class="text-muted">
                                Ng∆∞·ªùi d√πng c√≥ √≠t nh·∫•t 1 rating
                            </small>
                        </div>
                        <div class="col-md-2">
                            <div class="fw-bold text-uppercase text-secondary small mb-1">
                                Avg Rating
                            </div>
                            <h3 class="text-info mb-0">
                                {{ '%.2f'|format(stats.avg_rating) }}
                            </h3>
                            <small class="text-muted">
                                ƒêi·ªÉm ƒë√°nh gi√° trung b√¨nh
                            </small>
                        </div>
                        <div class="col-md-2">
                            <div class="fw-bold text-uppercase text-secondary small mb-1">
                                Median Rating
                            </div>
                            <h3 class="text-danger mb-0">
                                {{ '%.2f'|format(stats.median_rating) }}
                            </h3>
                            <small class="text-muted">
                                Trung v·ªã ƒë√°nh gi√°
                            </small>
                        </div>

                        <div class="col-md-2">
                            <div class="fw-bold text-uppercase text-secondary small mb-1">
                                Sparsity
                            </div>
                            <h3 class="text-secondary mb-0">
                                {{ '%.2f'|format(stats.sparsity) }}%
                            </h3>
                            <small class="text-muted">
                                % √¥ tr·ªëng user √ó item
                            </small>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Metrics -->
    {% if metrics %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h5 class="mb-0 text-light"> Model Performance Metrics</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-striped">
                            <thead>
                                <tr>
                                    <th>Model</th>
                                    <th>Precision@10</th>
                                    <th>Recall@10</th>
                                    <th>RMSE</th>
                                    <th>MAE</th>
                                    <th>Note</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if metrics.collaborative_svd %}
                                <tr>
                                    <td><span class="badge bg-primary">SVD</span></td>
                                    <td>{{ '%.2f'|format(metrics.collaborative_svd['precision@10'] * 100) }}%</td>
                                    <td>{{ '%.2f'|format(metrics.collaborative_svd['recall@10'] * 100) }}%</td>
                                    <td>{{ '%.3f'|format(metrics.collaborative_svd.rmse) }}</td>
                                    <td>{{ '%.3f'|format(metrics.collaborative_svd.mae) }}</td>
                                    <td class="text-muted small">{{ metrics.collaborative_svd.note }}</td>
                                </tr>
                                {% endif %}

                                {% if metrics.collaborative_itemknn %}
                                <tr>
                                    <td><span class="badge bg-success">ItemKNN</span></td>
                                    <td><strong>{{ '%.2f'|format(metrics.collaborative_itemknn['precision@10'] * 100)
                                            }}%</strong></td>
                                    <td><strong>{{ '%.2f'|format(metrics.collaborative_itemknn['recall@10'] * 100)
                                            }}%</strong></td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td class="text-muted small">{{ metrics.collaborative_itemknn.note }}</td>
                                </tr>
                                {% endif %}

                                {% if metrics.content_based_user_profile %}
                                <tr>
                                    <td><span class="badge bg-info">Content-Based</span></td>
                                    <td>{{ '%.2f'|format(metrics.content_based_user_profile['precision@10'] * 100) }}%
                                    </td>
                                    <td>{{ '%.2f'|format(metrics.content_based_user_profile['recall@10'] * 100) }}%</td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td class="text-muted small">User profile based</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>Evaluation Settings:</strong>
                            K={{ metrics.K }}, Holdout K={{ metrics.holdout_k }},
                            Like Threshold={{ metrics.like_threshold }},
                            Sample Users={{ metrics.n_sample_users }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Comprehensive Dashboard -->
    {% if visualizations.dashboard %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h5 class="mb-0">üìà Comprehensive Dashboard</h5>
                </div>
                <div class="card-body">
                    {{ visualizations.dashboard|safe }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Visualizations Grid -->
    <div class="row">
        <!-- Model Comparison -->
        {% if visualizations.model_comparison %}
        <div class="col-md-6 mb-4">
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h6 class="mb-0">Model Comparison</h6>
                </div>
                <div class="card-body">
                    {{ visualizations.model_comparison|safe }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Rating Distribution -->
        {% if visualizations.rating_distribution %}
        <div class="col-md-6 mb-4">
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h6 class="mb-0">Rating Distribution</h6>
                </div>
                <div class="card-body">
                    {{ visualizations.rating_distribution|safe }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Genre Frequency -->
        {% if visualizations.genre_frequency %}
        <div class="col-md-6 mb-4">
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h6 class="mb-0">Genre Frequency</h6>
                </div>
                <div class="card-body">
                    {{ visualizations.genre_frequency|safe }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Top Movies -->
        {% if visualizations.top_movies %}
        <div class="col-md-6 mb-4">
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h6 class="mb-0">Top Movies</h6>
                </div>
                <div class="card-body">
                    {{ visualizations.top_movies|safe }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Genre-Rating Heatmap -->
        {% if visualizations.genre_rating_heatmap %}
        <div class="col-md-6 mb-4">
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h6 class="mb-0">Genre-Rating Heatmap</h6>
                </div>
                <div class="card-body">
                    {{ visualizations.genre_rating_heatmap|safe }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- User Activity -->
        {% if visualizations.user_activity %}
        <div class="col-md-6 mb-4">
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h6 class="mb-0">User Activity Distribution</h6>
                </div>
                <div class="card-body">
                    {{ visualizations.user_activity|safe }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Item Popularity -->
        {% if visualizations.item_popularity %}
        <div class="col-md-6 mb-4">
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h6 class="mb-0">Item Popularity (Long Tail)</h6>
                </div>
                <div class="card-body">
                    {{ visualizations.item_popularity|safe }}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Actions -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h5 class="mb-0">üîß Admin Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="alert('Run: python scripts/enrich_tmdb_to_csv.py')">
                            üì• Enrich Data
                        </button>
                        <button class="btn btn-success" onclick="alert('Run: python scripts/evaluate_models.py')">
                            üéØ Evaluate Models
                        </button>
                        <button class="btn btn-info" onclick="alert('Run: python scripts/visualization.py')">
                            üìä Generate Visualizations
                        </button>
                        <button class="btn btn-warning" onclick="window.location.reload()">
                            üîÑ Refresh Dashboard
                        </button>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>Note:</strong> Run scripts from terminal, then refresh this page to see updated
                            visualizations.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

{% endblock %}